#include <iostream>
#include <vector>
#include <fstream>
#include <sstream>
#include <string>
#include <chrono>   // <-- agregado para medir tiempo

using namespace std;
using namespace std::chrono;  // <-- para usar high_resolution_clock

int filas = 0, columnas = 0;
vector<vector<int>> BM;
vector<vector<int>> testores;
vector<vector<int>> tipicos;

// ----------------------------------------
bool esTestorConjunto(const vector<int>& S) {
    if (S.empty()) return false;

    for (int f = 0; f < filas; f++) {
        bool cubierta = false;
        for (int col : S) {
            if (BM[f][col] == 1) {
                cubierta = true;
                break;
            }
        }
        if (!cubierta) return false;
    }
    return true;
}

// ----------------------------------------
bool factible(const vector<int>& S, int k) {
    for (int f = 0; f < filas; f++) {
        bool posible = false;

        for (int col : S) {
            if (BM[f][col] == 1) {
                posible = true;
                break;
            }
        }

        if (!posible) {
            for (int c = k; c < columnas; c++) {
                if (BM[f][c] == 1) {
                    posible = true;
                    break;
                }
            }
        }

        if (!posible) return false;
    }
    return true;
}

// ----------------------------------------
void BT(vector<int>& S, int k) {
    if (!factible(S, k)) return;

    if (esTestorConjunto(S)) {
        testores.push_back(S);
        return;
    }

    for (int c = k; c < columnas; c++) {
        S.push_back(c);
        BT(S, c + 1);
        S.pop_back();
    }
}

// ----------------------------------------
bool esTipicoConjunto(const vector<int>& S) {
    int n = S.size();
    if (n == 0) return false;

    int total = 1 << n;

    for (int mask = 1; mask < total; mask++) {
        if (mask == total - 1) continue;

        vector<int> sub;
        for (int i = 0; i < n; i++) {
            if (mask & (1 << i)) {
                sub.push_back(S[i]);
            }
        }

        if (esTestorConjunto(sub)) return false;
    }

    return true;
}

// ----------------------------------------
int main() {
    auto inicio = high_resolution_clock::now();  // <-- inicia cronometro

    cout << "=== Algoritmo BT (Backtracking con Poda) ===\n";
    cout << "Intentando leer 'matriz.txt'...\n";

    ifstream archivo("matriz.txt");
    if (!archivo.is_open()) {
        cout << "Error: No se pudo abrir el archivo 'matriz.txt'.\n";
        return 1;
    }

    string linea;
    BM.clear();
    while (getline(archivo, linea)) {
        if (linea.empty()) continue;
        stringstream ss(linea);
        vector<int> filaTemp;
        int valor;
        while (ss >> valor) filaTemp.push_back(valor);
        if (!filaTemp.empty()) BM.push_back(filaTemp);
    }
    archivo.close();

    filas = BM.size();
    if (filas > 0) {
        columnas = BM[0].size();
        cout << "Matriz cargada exitosamente: " << filas
             << " filas x " << columnas << " columnas.\n";
    } else {
        cout << "Error: La matriz esta vacia.\n";
        return 1;
    }

    vector<int> S;
    BT(S, 0);

    for (const auto& T : testores) {
        if (esTipicoConjunto(T)) tipicos.push_back(T);
    }

    cout << "\n=== TESTORES ENCONTRADOS ===\n";
    if (testores.empty()) cout << "(No existe ningun testor)\n";
    else {
        for (const auto& T : testores) {
            cout << "{ ";
            for (int col : T) cout << char('A' + col) << " ";
            cout << "}\n";
        }
    }

    cout << "\n=== TESTORES TIPICOS ===\n";
    if (tipicos.empty()) cout << "(No existe ningun testor tipico)\n";
    else {
        for (const auto& T : tipicos) {
            cout << "{ ";
            for (int col : T) cout << char('A' + col) << " ";
            cout << "}\n";
        }
    }

    // ----------------------------
    // TIEMPO DE EJECUCION
    // ----------------------------
    auto fin = high_resolution_clock::now();
    auto duracion = duration_cast<milliseconds>(fin - inicio);

    cout << "\n=== TIEMPO DE EJECUCION ===\n";
    cout << "Tiempo total: " << duracion.count() << " ms\n";

    return 0;
}

